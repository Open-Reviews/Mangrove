variables:
  UI_BUCKET: "mangrove.reviews"
  DOCS_BUCKET: "docs.mangrove.reviews"
  JS_BUCKET: "js.mangrove.reviews"
  BLOG_BUCKET: "blog.mangrove.reviews"
  UI_DIST: "E3R6KTTYJH0XRG"
  DOCS_DIST: "E2HRIGC1I7B7ZA"
  JS_DIST: "E3PQ8VOO0YPOZI"
  BLOG_DIST: "EAF2A9OTIB6LI"
  CI_DEBUG_TRACE: "true"
  VUE_APP_API_URL: "https://api.mangrove.reviews"
  VUE_APP_FILES_URL: "https://files.mangrove.reviews"
  VUE_APP_UPLOAD_URL: "https://upload.mangrove.reviews"

image: wilson208/circleci-awscli:node
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ui/node_modules/

build:
  script:
    - cd ui
    - yarn install
    - yarn generate
    - cd ../blog
    - yarn install
    - yarn build
    - cd ../libraries/mangrove-reviews-js
    - yarn install
    - yarn doc
    - cd ../../servers/reviewer/docs
    - yarn install
    - yarn doc

test:
  script:
    - cd libraries/mangrove-reviews-js
    - yarn install
    - yarn test

pages:
  variables:
    BASE_URL: "https://staging.mangrove.reviews"
  stage: deploy
  script:
    - cd ui
    - yarn install
    - yarn generate
    - cd ..
    - mkdir public
    - cp -r ui/dist/* public
  artifacts:
    paths:
      - public
  except:
    - master

production:
  variables:
    BASE_URL: "https://mangrove.reviews"
  stage: deploy
  script:
    - cd servers/reviewer/docs
    - yarn install
    - yarn doc
    - aws s3 rm s3://$DOCS_BUCKET --recursive
    - aws s3 cp --recursive ./dist s3://$DOCS_BUCKET
    - aws cloudfront create-invalidation --distribution-id $DOCS_DIST --paths "/*"
    - cd ../../../libraries/mangrove-reviews-js
    - yarn install
    - yarn doc
    - aws s3 rm s3://$JS_BUCKET --recursive
    - aws s3 cp --recursive ./dist s3://$JS_BUCKET
    - aws cloudfront create-invalidation --distribution-id $JS_DIST --paths "/*"
    - cd ../../ui
    - yarn install
    - yarn generate
    - aws s3 rm s3://$UI_BUCKET --recursive
    - aws s3 cp --recursive ./dist s3://$UI_BUCKET
    - aws cloudfront create-invalidation --distribution-id $UI_DIST --paths "/*"
    - cd ../blog
    - yarn install
    - yarn build
    - aws s3 rm s3://$BLOG_BUCKET --recursive
    - aws s3 cp --recursive ./public s3://$BLOG_BUCKET
    - aws cloudfront create-invalidation --distribution-id $BLOG_DIST --paths "/*"
  only:
    - master
