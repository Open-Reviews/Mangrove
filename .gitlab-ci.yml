variables:
  UI_BUCKET: "mangrove.reviews"
  JS_BUCKET: "js.mangrove.reviews"
  CDN_DISTRIBUTION_ID: "E3R6KTTYJH0XRG"
  CI_DEBUG_TRACE: "true"
  VUE_APP_API_URL: "https://api.mangrove.reviews"
  VUE_APP_FILES_URL: "https://files.mangrove.reviews"
  VUE_APP_UPLOAD_URL: "https://upload.mangrove.reviews"

image: wilson208/circleci-awscli:node
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ui/node_modules/

build:
  script:
    - cd ui
    - yarn install
    - yarn generate

test:
  script:
    - cd libraries/mangrove-reviews-js
    - yarn install
    - yarn test

pages:
  variables:
    BASE_URL: "https://staging.mangrove.reviews"
  stage: deploy
  script:
    - cd ui
    - yarn install
    - yarn generate
    - cd ..
    - mkdir public
    - cp -r ui/dist/* public
  artifacts:
    paths:
      - public
  except:
    - master

production:
  variables:
    BASE_URL: "https://mangrove.reviews"
  stage: deploy
  script:
    - cd libraries/mangrove-reviews-js
    - yarn doc
    - aws s3 rm s3://$JS_BUCKET --recursive
    - aws s3 cp --recursive ./dist s3://$JS_BUCKET
    - cd ../ui
    - yarn install
    - yarn generate
    - aws s3 rm s3://$UI_BUCKET --recursive
    - aws s3 cp --recursive ./dist s3://$UI_BUCKET
    - aws cloudfront create-invalidation --distribution-id E3R6KTTYJH0XRG --paths "/*"
  only:
    - master
